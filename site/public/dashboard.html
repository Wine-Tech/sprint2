<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Implementando o ChartJS</title>
    <link rel="stylesheet" href="dashboard.css">
    <script src="alertas.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>



    <div id="alerta"></div>
    <div id="alerta1"></div>


    <div class="header">
        <div class="nav">
            <img id="imgLogo" src="./assets/logoempresa.png">
            <ul class="navbar">
                <li><a href="./index.html">Home</a></li>
                <li><a href="./index.html#divProduto">Produtos</a></li>
                <li><a href="./index.html#divSobre">Sobre nós</a></li>
                <li><a href="./index.html#divContato">Contato</a></li>

            </ul>
        </div>
    </div>



    <h1 class="tituloMetricaPrincipal">Nivel de Alerta</h1>

    <section class="container4">

        <h1 class="tituloMetrica"> Temperatura </h1>

        <div class="cardMetricaCriticoAbaixoTemp">
            CRITICO BAIXO <br>
            12ºC
        </div>
        <div class="cardMetricaAlertaAbaixoTemp">
             ALERTA BAIXO <br>
              13ºC ~ 15ºC
        </div>
        <div class="cardMetricaIdealTemp">
            IDEAL <br>
            16ºC ~ 20ºC
        </div>
        <div class="cardMetricaAlertaTemp">
             ALERTA ALTO <br>
             21ºC ~ 23ºC 
        </div>
        <div class="cardMetricaCriticoTemp">
            CRITICO ALTO <br>
            24ºC
        </div>
    </section>




    <section class="container4">

        <h1 class="tituloMetrica"> Umidade</h1>

        <div class="cardMetricaCriticoAbaixoUmi">
            CRITICO BAIXO <br>
            50%
        </div>
        <div class="cardMetricaAlertaAbaixoUmi">
             ALERTA BAIXO <br>
             51% ~ 53%
        </div>
        <div class="cardMetricaIdealUmi">
             IDEAL <br>
             54% ~ 56%
        </div>
        <div class="cardMetricaAlertaUmi">
            ALERTA ALTO <br>
             57% ~ 59%
        </div>
        <div class="cardMetricaCriticoUmi">
            CRITICO ALTO <br>
            60%
        </div>

    </section>


    <div id="divLocaisSensor" class="conteudoEscolha">
        <!-- <div>testando</div> -->
        <div id="divBotoesLocais" style="justify-content: center; align-items: center;">
            <h1 class="tituloEscolha">Escolha um local para ver os dados: </h1>
        </div>
        <!-- <select name="" id="button"> -->
        <!-- <option value="">ARMAZÉM 1</option> -->
        <!-- <option value="">ARMAZÉM 2</option> -->
        <!-- </select> -->
        <!-- <div>
            <div id="divBotoesLocais">
                <div>AAAAAAAAAAA</div>
                <div>BBBBBBBBBBB</div>
                <div>CCCCCCCCCCC</div>
            </div>
        </div> -->

    </div>


    <section class="container2">

        <div class="tabela1">

            <h1 class="tituloTabela">Temperatura e umidade diária</h1>
            <canvas id="myChartVinho1" style="position:relative; height:40vh; width:50vw"></canvas>

        </div>

        <div class="card1">
            <div class="conteudo1">
                <div class="cor-alerta" id="card_1"></div>
                TEMPERATURA MÁXIMA NO DIA
                <div id="porcentagem1" class="porcentagem1">
                    30ºC
                </div>

            </div>

        </div>

        <div id="card_2" class="card2">
            <div class="conteudo1">

                UMIDADE MÁXIMA NO DIA
                <div id="porcentagem2" class="porcentagem2">
                    57%
                </div>

            </div>

        </div>
    </section>

    <section class="container3">

        <!-- </div> -->
        <div class="tabela2">
            <h1 class="tituloTabela">Média temperatura e umidade dos ultimos 7 dias</h1>
            <canvas id="myChart2" style="position:relative; height:40vh; width:50vw"></canvas>
        </div>
        <div id="card_3" class="card3">
            <div class="conteudo1">
                TEMPERATURA MÍNIMA NO DIA
                <div id="porcentagem3" class="porcentagem3">
                    11ºC
                </div>

            </div>

        </div>

        <div id="card_4" class="card4">
            <div class="conteudo1">
                UMIDADE MÍNIMA NO DIA
                <div id="porcentagem4" class="porcentagem4">
                    59%
                </div>

            </div>
        </div>


    </section>

</body>

<!-- <script>
    Chart.defaults.color = '#FFFFFF';

    const optionsCritUmidade = {
        plugins: {
            annotation: {
                annotations: {
                    line1: {
                        type: 'line',
                        yMin: 50,
                        yMax: 60,
                        borderColor: '#F89E26',
                        borderWidth: 2,
                    }
                }
            }
        }
    };

    const labels = [
        '25/06/2001 00:00:00',

        '25/06/2001 02:00:00',

        '25/06/2001 04:00:00',

        '25/06/2001 06:00:00',

        '25/06/2001 08:00:00',

        '25/06/2001 10:00:00',

        '25/06/2001 12:00:00',

        '25/06/2001 14:00:00',

        '25/06/2001 16:00:00',

        '25/06/2001 18:00:00',

        '25/06/2001 20:00:00',

        '26/06/2001 22:00:00',

    ];

    const labels2 = [
        'Segunda',
        'Terça',
        'Quarta',
        'Quinta',
        'Sexta',
        'Sábado',
        'Domingo'

    ];

    const data = {
        labels: labels,
        datasets: [{
            label: "Temperatura",
            backgroundColor: "rgb(212, 145, 78)",
            borderColor: "rgb(212, 145, 78)",
            data: [12, 10, 12, 15, 20, 22, 22, 30, 15, 13, 12, 22],
        },
        {
            label: "Umidade",
            backgroundColor: "rgb(108, 91, 217)",
            borderColor: "rgb(108, 91, 217)",
            data: [53, 58, 54, 57, 57, 55, 55, 53, 54, 53, 57, 57],
        }
        ],
        optionsCritUmidade
    };

    const data2 = {
        labels: labels2,
        datasets: [{
            label: "Média da Temperatura",
            backgroundColor: "rgb(212, 145, 78)",
            borderColor: "rgb(212, 145, 78)",
            // backgroundColor: "rgb(52, 235, 98)",
            // borderColor: "rgb(52, 235, 98)",
            data: [15, 20, 25, 19, 23, 30, 10, 12, 24, 20],
        },
        {
            label: "Média da Umidade",
            backgroundColor: "rgb(108, 91, 217)",
            borderColor: "rgb(108, 91, 217)",
            // backgroundColor: "rgb(52, 161, 235)",
            //  borderColor: "rgb(52, 161, 235)",
            data: [50, 55, 52, 55, 60, 54, 50, 50, 56, 58, 55, 60],

        }
        ]
    };

    const config = {
        type: `line`,
        data: data,
        options: {}
    };

    const config2 = {
        type: `bar`,
        data: data2,
        options: {}
    }; -->


<!-- </script> -->

<script>
    var nomeUsuario = sessionStorage.NOME_USUARIO;
    var idUsuario = sessionStorage.ID_USUARIO;
    var fkEmpresa = sessionStorage.FK_EMPRESA;

    //recuperando informações do local e de sensores
    var localSensor = []
    var nomeLocal = []
    var sensores = []

    //fetch locais da empresa ///////////////////////////////////////////////////////////////
    fetch("/medidas/recuperarLocais", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            // crie um atributo que recebe o valor recuperado aqui
            // Agora vá para o arquivo routes/usuario.js
            fkEmpresaServer: fkEmpresa
        })
    }).then(function (resposta) {

        console.log("resposta: ", resposta);

        if (resposta.ok) {

            resposta.json().then(json => {
                console.log(json);
                console.log(JSON.stringify(json));

                jsonResponse = json.length;

                if (jsonResponse > 0) {

                    for (var i = 0; i < jsonResponse; i++) {
                        var localAtual = json[i];
                        localSensor.push(localAtual.id);
                        nomeLocal.push(localAtual.nome);

                        for (var i = 0; i < jsonResponse; i++) {
                            divBotoesLocais.innerHTML += `<div><button> ${nomeLocal[i]} ${i + 1} </button></div>`
                        }
                    }
                }

            });

        } else {
            throw ("Houve um erro ao tentar realizar o cadastro!");
        }
    }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
    });

    //fetch sensores ////////////////////////////////////////////////////////////////////

    for (var i = 0; i < localSensor.length; i++) {
        var localAtual = localSensor[i];

        fetch("/medidas/recuperarSensores", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/usuario.js
                fkLocalSensorServer: localAtual
            })
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));

                    jsonResponse = json.length;

                    if (jsonResponse > 0) {

                        for (var i = 0; i < jsonResponse; i++) {
                            var sensorAtual = json[i];
                            sensores.push(localAtual.id);
                            // nomeLocal.push(localAtual.nome);

                            for (var i = 0; i < jsonResponse; i++) {
                                divBotoesLocais.innerHTML += `<div><button> Sensor${[i]} ${i + 1} </button></div>`
                            }
                        }
                    }

                });

            } else {
                throw ("Houve um erro ao tentar realizar o cadastro!");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });

    }

    //fetch dados do sensor

    let proximaAtualizacao;

    window.onload = obterDadosGraficos();

    function obterDadosGraficos() {
        obterDadosGrafico(1)
    }

    // obterDadosGraficos()

    function obterDadosGrafico(idLocal) {

        // alterarTitulo(idLocal)

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/ultimas/${idLocal}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, idLocal);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGrafico(resposta, idLocal) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // let labels2 = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Umidade',
                data: [],
                fill: false,
                // backgroundColor: "rgb(212, 145, 78)",
                borderColor: 'rgb(212, 145, 78)',
                tension: 0.1
            },
            {
                label: 'Temperatura',
                data: [],
                fill: false,
                // backgroundColor: "rgb(108, 91, 217)",
                borderColor: 'rgb(108, 91, 217)',
                tension: 0.1
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.momento_grafico);
            dados.datasets[0].data.push(registro.umidade);
            dados.datasets[1].data.push(registro.temperatura);
        }


        // let dados2 = {
        //     labels: labels2,
        //     datasets: [{
        //         label: "Média da Temperatura",
        //         backgroundColor: "rgb(212, 145, 78)",
        //         borderColor: "rgb(212, 145, 78)",
        //         data: [],
        //         tension: 0.1
        //     },
        //     {
        //         label: "Média da Umidade",
        //         backgroundColor: "rgb(108, 91, 217)",
        //         borderColor: "rgb(108, 91, 217)",
        //         data: [],
        //         fill: false,
        //         tension: 0.1

        //     }]
        // }
        alertar(resposta, idLocal);
        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')
        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
        };

        // const config2 = {
        //     type: 'line',
        //     data: dados2,
        // };

        // Adicionando gráfico criado em div na tela
        let myChartVinho = new Chart(
            document.getElementById(`myChartVinho${idLocal}`),
            config
        );

        // let myChart2 = new Chart(
        //     document.getElementById(`myChart2${idLocal}`),
        //     config2
        // );

        setTimeout(() => atualizarGrafico(idLocal, dados, myChartVinho), 2000);
        // setTimeout(() => atualizarGrafico(idLocal, dados, myChart2), 2000);
    };


    function atualizarGrafico(idLocal, dados, myChart) {



        fetch(`/medidas/tempo-real/${idLocal}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);

                    let avisoCaptura = document.getElementById(`avisoCaptura${idLocal}`)
                    // avisoCaptura.innerHTML = ""


                    if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        // avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].momento_grafico)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

                        dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                        dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                        myChart.update();
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idLocal, dados, myChart), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idLocal, dados, myChart), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    };
</script>

</html>